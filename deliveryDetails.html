<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Details - SENEN</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
    }
    body {
      background: #fff;
      color: #000;
    }
    .header {
      background: #000;
      padding: 12px 0;
      text-align: center;
    }
    .header img {
      height: 30px;
      cursor: pointer;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      padding: 0 20px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .form-section {
      background: #f9f9f9;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    .section-title svg {
      margin-right: 10px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn {
      display: inline-block;
      padding: 14px 28px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #333;
    }
    .btn-block {
      display: block;
      width: 100%;
    }
    .order-summary {
      background: #f9f9f9;
      padding: 25px;
      border-radius: 10px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .summary-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .summary-title {
      font-weight: 600;
    }
    .product-image-sm {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }
    .product-details-summary {
      flex-grow: 1;
      padding-left: 15px;
    }
    .error-message {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    .invalid {
      border-color: #d32f2f;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="D:\Rithik\SenenCatalog\New\kosans-demo.regular.webp" alt="SENEN Logo" onclick="goToCatalog()">
  </div>

  <div class="container">
    <h2>Delivery Details</h2>
    
    <div class="form-section">
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        Shipping Address
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" placeholder="Your full name" onkeypress="return validateTextInput(event)">
          <div class="error-message" id="fullNameError">Please enter a valid name (letters and spaces only)</div>
        </div>
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" placeholder="9876543210" maxlength="10" onkeypress="return validateNumberInput(event)">
          <div class="error-message" id="phoneError">Please enter a valid 10-digit phone number</div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="address">Address</label>
        <textarea id="address" placeholder="House number, street, apartment"></textarea>
        <div class="error-message" id="addressError">Please enter your address</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" placeholder="Your city" onkeypress="return validateTextInput(event)">
          <div class="error-message" id="cityError">Please enter a valid city name</div>
        </div>
        <div class="form-group">
          <label for="state">State</label>
          <input type="text" id="state" placeholder="Your state" onkeypress="return validateTextInput(event)">
          <div class="error-message" id="stateError">Please enter a valid state name</div>
        </div>
        <div class="form-group">
          <label for="pincode">Pincode</label>
          <input type="text" id="pincode" placeholder="Pincode" maxlength="6" onkeypress="return validateNumberInput(event)">
          <div class="error-message" id="pincodeError">Please enter a valid 6-digit pincode</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        Contact Information
      </div>
      
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="your.email@example.com" onblur="validateEmail()">
        <div class="error-message" id="emailError">Please enter a valid email address</div>
      </div>
    </div>
    
    <div class="order-summary">
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        Order Summary
      </div>
      
      <div class="summary-item">
        <div>
          <img src="" alt="Product" class="product-image-sm" id="summaryProductImage">
        </div>
        <div class="product-details-summary">
          <div id="summaryProductName">Product Name</div>
          <div>Size: <span id="summaryProductSize">-</span></div>
          <div>Qty: <span id="summaryProductQty">-</span></div>
        </div>
        <div id="summaryProductPrice">₹0</div>
      </div>
      
      <div class="summary-item">
        <div class="summary-title">Subtotal</div>
        <div id="summarySubtotal">₹0</div>
      </div>
      
      <div class="summary-item">
        <div class="summary-title">Shipping</div>
        <div>FREE</div>
      </div>
      
      <div class="summary-item">
        <div class="summary-title">Total</div>
        <div style="font-weight: 600;" id="summaryTotal">₹0</div>
      </div>
    </div>
    
    <button class="btn btn-block" onclick="proceedToPayment()">Proceed to Payment</button>
  </div>

  <script>
    // Initialize IndexedDB
    let db;

    function goToCatalog(){
      window.location.href = 'catalog.html';
    }
    
    // Input validation functions
    function validateNumberInput(event) {
      const charCode = event.which ? event.which : event.keyCode;
      // Allow only numbers (0-9)
      if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        event.preventDefault();
        return false;
      }
      return true;
    }

    function validateTextInput(event) {
      const charCode = event.which ? event.which : event.keyCode;
      // Allow only letters (a-z, A-Z) and space
      if (charCode > 31 && 
          !(charCode >= 65 && charCode <= 90) && // A-Z
          !(charCode >= 97 && charCode <= 122) && // a-z
          charCode !== 32) { // space
        event.preventDefault();
        return false;
      }
      return true;
    }

    function validateEmail() {
      const emailInput = document.getElementById('email');
      const emailError = document.getElementById('emailError');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!emailRegex.test(emailInput.value)) {
        emailInput.classList.add('invalid');
        emailError.style.display = 'block';
        return false;
      } else {
        emailInput.classList.remove('invalid');
        emailError.style.display = 'none';
        return true;
      }
    }

    function validateForm() {
      let isValid = true;
      
      // Validate full name
      const fullName = document.getElementById('fullName');
      const fullNameError = document.getElementById('fullNameError');
      if (!fullName.value.trim() || !/^[a-zA-Z\s]+$/.test(fullName.value)) {
        fullName.classList.add('invalid');
        fullNameError.style.display = 'block';
        isValid = false;
      } else {
        fullName.classList.remove('invalid');
        fullNameError.style.display = 'none';
      }
      
      // Validate phone
      const phone = document.getElementById('phone');
      const phoneError = document.getElementById('phoneError');
      if (!phone.value.trim() || !/^\d{10}$/.test(phone.value)) {
        phone.classList.add('invalid');
        phoneError.style.display = 'block';
        isValid = false;
      } else {
        phone.classList.remove('invalid');
        phoneError.style.display = 'none';
      }
      
      // Validate address
      const address = document.getElementById('address');
      const addressError = document.getElementById('addressError');
      if (!address.value.trim()) {
        address.classList.add('invalid');
        addressError.style.display = 'block';
        isValid = false;
      } else {
        address.classList.remove('invalid');
        addressError.style.display = 'none';
      }
      
      // Validate city
      const city = document.getElementById('city');
      const cityError = document.getElementById('cityError');
      if (!city.value.trim() || !/^[a-zA-Z\s]+$/.test(city.value)) {
        city.classList.add('invalid');
        cityError.style.display = 'block';
        isValid = false;
      } else {
        city.classList.remove('invalid');
        cityError.style.display = 'none';
      }
      
      // Validate state
      const state = document.getElementById('state');
      const stateError = document.getElementById('stateError');
      if (!state.value.trim() || !/^[a-zA-Z\s]+$/.test(state.value)) {
        state.classList.add('invalid');
        stateError.style.display = 'block';
        isValid = false;
      } else {
        state.classList.remove('invalid');
        stateError.style.display = 'none';
      }
      
      // Validate pincode
      const pincode = document.getElementById('pincode');
      const pincodeError = document.getElementById('pincodeError');
      if (!pincode.value.trim() || !/^\d{6}$/.test(pincode.value)) {
        pincode.classList.add('invalid');
        pincodeError.style.display = 'block';
        isValid = false;
      } else {
        pincode.classList.remove('invalid');
        pincodeError.style.display = 'none';
      }
      
      // Validate email
      if (!validateEmail()) {
        isValid = false;
      }
      
      return isValid;
    }

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('SenenProductsDB', 4);
        
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve();
        };
        
        request.onerror = (event) => {
          console.error('Database error:', event.target.error);
          reject(event.target.error);
        };
      });
    }

    // Get product from IndexedDB
    function getProductFromDB(id) {
      return new Promise((resolve) => {
        const transaction = db.transaction(['products'], 'readonly');
        const store = transaction.objectStore('products');
        const request = store.get(id);
        
        request.onsuccess = (event) => {
          resolve(event.target.result || null);
        };
        
        request.onerror = () => resolve(null);
      });
    }

    // Get product images from IndexedDB
    function getProductImages(productId) {
      return new Promise((resolve) => {
        const transaction = db.transaction(['productImages'], 'readonly');
        const store = transaction.objectStore('productImages');
        const index = store.index('byProduct');
        const request = index.getAll(IDBKeyRange.only(productId));
        
        request.onsuccess = (event) => {
          const images = (event.target.result || [])
            .sort((a, b) => a.index - b.index)
            .map(item => {
              // Create object URL from Blob
              if (item.imageBlob) {
                return URL.createObjectURL(item.imageBlob);
              }
              // Fallback for old data format (base64)
              return item.imageData;
            });
          resolve(images);
        };
        
        request.onerror = () => resolve([]);
      });
    }

    // Load order details from previous page and database
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await initDB();
        
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        
        if (!productId) {
          console.error('No product ID found in URL');
          return;
        }
        
        // Get product details from DB
        const product = await getProductFromDB(productId);
        const images = await getProductImages(productId);
        
        if (!product) {
          console.error('Product not found in database');
          return;
        }
        
        // Get size and quantity from localStorage
        const selectedSize = localStorage.getItem('selected_size') || 'Not selected';
        const selectedQuantity = localStorage.getItem('selected_quantity') || 1;
        
        // Populate order summary
        document.getElementById('summaryProductName').textContent = product.name || 'Product Name';
        document.getElementById('summaryProductSize').textContent = selectedSize;
        document.getElementById('summaryProductQty').textContent = selectedQuantity;
        
        // Display first product image if available
        if (images.length > 0) {
          document.getElementById('summaryProductImage').src = images[0];
        } else {
          document.getElementById('summaryProductImage').src = 'https://via.placeholder.com/60';
        }
        
        // Calculate totals
        const subtotal = ((parseFloat(product.price) || 0) * (parseInt(selectedQuantity) || 1));
        document.getElementById('summaryProductPrice').textContent = `₹${product.price || 0}`;
        document.getElementById('summarySubtotal').textContent = `₹${subtotal}`;
        document.getElementById('summaryTotal').textContent = `₹${subtotal}`;
        
      } catch (error) {
        console.error('Error loading order details:', error);
        alert('Failed to load order details');
      }
    });

    async function proceedToPayment() {
      // Validate form before proceeding
      if (!validateForm()) {
        return;
      }
      
      // Collect form data
      const fullName = document.getElementById('fullName').value;
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const pincode = document.getElementById('pincode').value;
      const email = document.getElementById('email').value;
      
      // Get product ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      // Get size and quantity from localStorage
      const size = localStorage.getItem('selected_size');
      const quantity = localStorage.getItem('selected_quantity');
      
      await initDB();
      // Get product details from DB
      const product = await getProductFromDB(productId);
      
      // Create comprehensive order details object
      const orderDetails = {
        id: Date.now(), // Unique ID for the order
        fullName,
        phone,
        address,
        city,
        state,
        pincode,
        email,
        productId,
        productName: product.name,
        price: product.price, // Store product price
        size,
        quantity,
        date: new Date().toISOString(),
        status: 'pending', // Initial status
        paymentMethod: 'PER PAID',
        shippingMethod: 'standard' // Default shipping
      };
      
      // Save order details to IndexedDB
      saveOrderToIndexedDB(orderDetails)
        .then(() => {
          // Clear temporary storage
          localStorage.removeItem('selected_size');
          localStorage.removeItem('selected_quantity');
          
          // Proceed to payment page only after successful save
          window.location.href = 'confirm.html';
        })
        .catch(error => {
          console.error('Error saving order:', error);
          alert('Failed to save order details. Please try again.');
        });
    }
    
    function saveOrderToIndexedDB(order) {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('SenenOrdersDB', 4);
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('orders')) {
            const store = db.createObjectStore('orders', { keyPath: 'id' });
            // Create indexes for better querying
            store.createIndex('byStatus', 'status', { unique: false });
            store.createIndex('byDate', 'date', { unique: false });
          }
        };
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          const transaction = db.transaction(['orders'], 'readwrite');
          const store = transaction.objectStore('orders');
          
          const addRequest = store.add(order);
          
          addRequest.onsuccess = () => {
            console.log('Order successfully saved to IndexedDB');
            resolve();
          };
          
          addRequest.onerror = (event) => {
            console.error('Error adding order:', event.target.error);
            reject(event.target.error);
          };
        };
        
        request.onerror = (event) => {
          console.error('Database open error:', event.target.error);
          reject(event.target.error);
        };
      });
    }
  </script>
</body>
</html>