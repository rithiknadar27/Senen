<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Products</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
        }

        .header {
            background: #000;
            padding: 10px 0;
            text-align: center;
            position: relative;
        }

        .header img {
            height: 30px;
        }

        .container {
            padding: 0 15px;
        }

        /* TAB STYLING */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f4f4f4;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
            color: #000;
            background-color: #fff;
        }

        .tab:hover:not(.active) {
            background-color: #e0e0e0;
        }

        /* PRODUCTS TAB STYLING */
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
        }

        input,
        button,
        textarea,
        select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        input[type="password"],
        textarea,
        select {
            flex: 1;
            min-width: 200px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn-container {
            width: 100%;
            display: flex;
            justify-content: flex-end;
        }

        .submit-btn-container button {
            background: black;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 10px;
            max-width: 200px;
        }

        table {
            background: white;
            width: 100%;
            max-width: 98%;
            border-collapse: collapse;
            margin: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        .image-names {
            max-width: 200px;
            word-wrap: break-word;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .icon-btn {
            background-color: black;
            color: white;
            border: none;
            border-radius: 50%;
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Image preview styling */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .preview-image {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-image .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image .move-handle {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .preview-image.dragging {
            opacity: 0.5;
        }

        /* MODAL STYLING */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 300px;
        }

        .modal-content p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .confirm-btn {
            background-color: black;
            color: white;
        }

        .cancel-btn {
            background-color: #ccc;
            color: black;
        }

        /* LOADING INDICATOR */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
        }

        .logout-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .logout-icon {
            width: 24px;
            height: 24px;
            filter: invert(100%);
        }

        .back-button {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .back-icon {
            width: 24px;
            height: 24px;
            filter: invert(100%);
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .submit-btn-container {
                justify-content: center;
            }

            table,
            th,
            td {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <button class="back-button" onclick="window.location.href='admin-dashboard.html'">
            <img class="back-icon" src="https://cdn-icons-png.flaticon.com/512/3114/3114883.png" alt="Back">
        </button>
        <img src="kosans-demo.regular.webp" alt="SENEN Logo" />
        <div class="logout-btn">
            <img class="logout-icon" src="https://cdn-icons-png.flaticon.com/512/126/126467.png" alt="Logout"
                onclick="logout()">
        </div>
    </div>

    <div class="loading" id="loadingIndicator">
        Processing, please wait...
    </div>

    <div class="container">
        <!-- <div class="tabs">
      <div class="tab active" onclick="window.location.href='products.html'">Products</div>
      <div class="tab" onclick="window.location.href='orders.html'">Orders</div>
      <div class="tab" onclick="window.location.href='deleted.html'">Deleted Products</div>
    </div> -->

        <!-- PRODUCTS TAB -->
        <div id="products-tab">
            <h2>Add New Product</h2>
            <form onsubmit="saveProduct(event)">
                <div class="form-row">
                    <input type="text" id="name" placeholder="Product Name" required />
                    <input type="number" id="price" placeholder="Price (INR)" required />
                    <input type="number" id="maxCount" name="maxCount" placeholder="Max Count" min="1" required>
                    <input type="file" id="image" multiple accept="image/*" required />
                </div>
                <div class="form-row">
                    <div id="imagePreview" class="image-preview-container"></div>
                </div>
                <div class="form-row">
                    <textarea id="description" placeholder="Product Description" required></textarea>
                    <textarea id="details" placeholder="Product Details (one per line)" required></textarea>
                </div>
                <div class="submit-btn-container">
                    <button type="submit" id="submitBtn">Add Product</button>
                </div>
            </form>

            <h2>Product List</h2>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>Images</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Max Count</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to delete this product?</p>
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="confirmDelete()">Yes</button>
                <button class="cancel-btn" onclick="closeModal()">No</button>
            </div>
        </div>
    </div>

    <script>
        // Session configuration
        const SESSION_DURATION = 6 * 60 * 60 * 1000; // 6 hours in milliseconds

        // Check authentication status
        function checkAuth() {
            const sessionExpires = localStorage.getItem('sessionExpires');

            if (localStorage.getItem('adminSession') !== 'true' ||
                !sessionExpires ||
                Date.now() > parseInt(sessionExpires)) {
                // Session expired or not logged in
                endSession();
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }

        // Reset session timer on user activity
        function resetSessionTimer() {
            const newExpiration = Date.now() + SESSION_DURATION;
            localStorage.setItem('sessionExpires', newExpiration.toString());
        }

        // End session (logout)
        function endSession() {
            localStorage.removeItem('adminSession');
            localStorage.removeItem('sessionExpires');
        }

        // Add logout button functionality
        function setupLogoutButton() {
            const logoutBtn = document.createElement('div');
            logoutBtn.className = 'logout-btn';
            logoutBtn.innerHTML = `
        <img class="logout-icon" src="https://cdn-icons-png.flaticon.com/512/126/126467.png" alt="Logout" onclick="logout()">
      `;
            document.querySelector('.header').appendChild(logoutBtn);
        }

        function logout() {
            endSession();
            window.location.href = 'admin-login.html';
        }

        let productsDb;
        let editIndex = -1;
        let deleteIndex = -1;
        const table = document.querySelector("#productTable tbody");
        const modal = document.getElementById("deleteModal");

        // Initialize the database
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SenenProductsDB', 6);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;

                    if (oldVersion < 1) {
                        const productsStore = db.createObjectStore('products', { keyPath: 'id' });
                        productsStore.createIndex('byActive', 'isActive', { unique: false });
                        // Add maxCount to new products
                        const store = db.createObjectStore('productImages', { keyPath: ['productId', 'index'] });
                        store.createIndex('byProduct', 'productId', { unique: false });
                    }

                    // For existing databases, we need to handle data migration
                    if (oldVersion < 6) { // Increment version number
                        const transaction = event.target.transaction;
                        const store = transaction.objectStore('products');

                        // Get all products and add maxCount field
                        store.getAll().onsuccess = function (e) {
                            const products = e.target.result;
                            products.forEach(product => {
                                if (product.maxCount === undefined) {
                                    product.maxCount = 0; // Default value
                                    store.put(product);
                                }
                            });
                        };
                    }
                };

                request.onsuccess = (event) => {
                    productsDb = event.target.result;
                    resolve();
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        // Save product to IndexedDB
        async function saveProductToDB(product) {
            showLoading();
            try {
                // First save product metadata
                await new Promise((resolve, reject) => {
                    const transaction = productsDb.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const request = store.put(product);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });

                // Delete existing images if editing
                if (editIndex > -1) {
                    await new Promise((resolve, reject) => {
                        const transaction = productsDb.transaction(['productImages'], 'readwrite');
                        const store = transaction.objectStore('productImages');
                        const index = store.index('byProduct');
                        const request = index.openCursor(IDBKeyRange.only(product.id));

                        request.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                if (cursor.value.imageUrl) {
                                    URL.revokeObjectURL(cursor.value.imageUrl);
                                }
                                cursor.delete();
                                cursor.continue();
                            } else {
                                resolve();
                            }
                        };
                        request.onerror = () => reject(request.error);
                    });
                }

                // Save each image as Blob
                for (const [index, file] of product.imageFiles.entries()) {
                    await new Promise((resolve, reject) => {
                        const transaction = productsDb.transaction(['productImages'], 'readwrite');
                        const store = transaction.objectStore('productImages');
                        const request = store.add({
                            productId: product.id,
                            imageBlob: file,
                            imageName: file.name,
                            index
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }
            } finally {
                hideLoading();
            }
        }

        // Get products from IndexedDB
        async function getProductsFromDB() {
            return new Promise((resolve) => {
                const transaction = productsDb.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const allProducts = event.target.result || [];
                    // Filter active products in memory if index doesn't exist
                    const activeProducts = allProducts.filter(product =>
                        product.isActive !== false // Include if undefined or true
                    );
                    resolve(activeProducts);
                };

                request.onerror = () => resolve([]);
            });
        }

        // Get image info for a product from IndexedDB
        async function getProductImageInfo(productId) {
            return new Promise((resolve) => {
                const transaction = productsDb.transaction(['productImages'], 'readonly');
                const store = transaction.objectStore('productImages');
                const index = store.index('byProduct');
                const request = index.getAll(IDBKeyRange.only(productId));

                request.onsuccess = (event) => {
                    const imageInfo = (event.target.result || [])
                        .sort((a, b) => a.index - b.index)
                        .map(item => {
                            const url = item.imageBlob ? URL.createObjectURL(item.imageBlob) : '';
                            return {
                                url: url,
                                name: item.imageName
                            };
                        });
                    resolve(imageInfo);
                };

                request.onerror = () => resolve([]);
            });
        }

        // Delete product from IndexedDB
        async function deleteProductFromDB(productId) {
            showLoading();
            try {
                // First get the product
                const product = await new Promise((resolve, reject) => {
                    const transaction = productsDb.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const request = store.get(productId);

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });

                if (!product) {
                    throw new Error('Product not found');
                }

                // Update the product to inactive
                product.isActive = false;
                product.deletedOn = new Date().toISOString();

                // Save the updated product
                await new Promise((resolve, reject) => {
                    const transaction = productsDb.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    const request = store.put(product);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });

            } finally {
                hideLoading();
            }
        }

        // Render products table with image names
        async function renderProducts() {
            showLoading();
            try {
                const products = await getProductsFromDB();
                table.innerHTML = '';

                for (const product of products) {
                    const imageInfo = await getProductImageInfo(product.id);
                    const imagesText = imageInfo.map(info => info.name).join(', ');

                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="image-names">${imagesText}</td>
            <td>${product.name}</td>
            <td>₹${product.price}</td>
            <td>${product.maxCount}</td>
            <td>
              <div class="action-buttons">
                <button class="icon-btn edit-btn" data-id="${product.id}" title="Edit">&#9998;</button>
                <button class="icon-btn delete-btn" data-id="${product.id}" title="Delete">&#10006;</button>
              </div>
            </td>
          `;
                    table.appendChild(row);

                    // Add event listeners directly to the new buttons
                    row.querySelector('.edit-btn').addEventListener('click', () => editProduct(product.id));
                    row.querySelector('.delete-btn').addEventListener('click', () => showModal(product.id));
                }
            } finally {
                hideLoading();
            }
        }

        // Save product form handler
        async function saveProduct(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value;
            const details = document.getElementById('details').value.split('\n').filter(item => item.trim() !== '');
            const imageInput = document.getElementById('image');
            const maxCount = parseInt(document.getElementById('maxCount').value || 1);

            // Get the files in the order they appear in the preview
            const previewContainer = document.getElementById('imagePreview');
            const previewElements = Array.from(previewContainer.querySelectorAll('.preview-image'));
            const orderedFiles = previewElements.map(el => {
                const index = el.dataset.index;
                return imageInput.files[index];
            }).filter(Boolean);

            if (orderedFiles.length === 0) {
                alert("Please select at least one image.");
                return;
            }

            try {
                const productId = editIndex !== -1 ? editIndex : Date.now().toString();
                const newProduct = {
                    id: productId,
                    name,
                    price,
                    maxCount,
                    description,
                    details,
                    imageFiles: orderedFiles,
                    isActive: true // Default to active
                };

                await saveProductToDB(newProduct);

                document.querySelector('form').reset();
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('submitBtn').textContent = 'Add Product';
                editIndex = -1;
                await renderProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Failed to save product: ' + error.message);
            }
        }

        // Edit product
        async function editProduct(productId) {
            showLoading();
            try {
                const transaction = productsDb.transaction(['products'], 'readonly');
                const store = transaction.objectStore('products');
                const request = store.get(productId);

                request.onsuccess = async (event) => {
                    const product = event.target.result;
                    if (product) {
                        document.getElementById('name').value = product.name;
                        document.getElementById('price').value = product.price;
                        document.getElementById('maxCount').value = product.maxCount;
                        document.getElementById('description').value = product.description || '';
                        document.getElementById('details').value = product.details ? product.details.join('\n') : '';
                        document.getElementById('submitBtn').textContent = 'Update Product';
                        editIndex = product.id;

                        // Load images for editing
                        const imageInfo = await getProductImageInfo(productId);
                        const previewContainer = document.getElementById('imagePreview');
                        previewContainer.innerHTML = '';

                        // Create a DataTransfer object to hold the files
                        const dataTransfer = new DataTransfer();

                        for (const [index, info] of imageInfo.entries()) {
                            // Fetch the blob to create a File object
                            const response = await fetch(info.url);
                            const blob = await response.blob();
                            const file = new File([blob], info.name, { type: blob.type });
                            dataTransfer.items.add(file);

                            // Create preview
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'preview-image';
                            previewDiv.dataset.index = index;
                            previewDiv.draggable = true;

                            previewDiv.innerHTML = `
                <img src="${info.url}" alt="Preview">
                <button class="remove-btn" data-index="${index}">×</button>
                <button class="move-handle" data-index="${index}">↕</button>
              `;

                            previewContainer.appendChild(previewDiv);
                            setupDragAndDrop(previewDiv);
                        }

                        // Update the file input
                        const fileInput = document.getElementById('image');
                        fileInput.files = dataTransfer.files;
                    }
                };
            } finally {
                hideLoading();
            }
        }

        // Setup drag and drop for image reordering
        function setupDragAndDrop(element) {
            element.addEventListener('dragstart', function (e) {
                e.dataTransfer.setData('text/plain', this.dataset.index);
                this.classList.add('dragging');
            });

            element.addEventListener('dragend', function () {
                this.classList.remove('dragging');
            });
        }

        // Handle drop events for reordering
        document.getElementById('imagePreview').addEventListener('dragover', function (e) {
            e.preventDefault();
            const dragging = document.querySelector('.preview-image.dragging');
            const afterElement = getDragAfterElement(this, e.clientY);

            if (afterElement == null) {
                this.appendChild(dragging);
            } else {
                this.insertBefore(dragging, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.preview-image:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Handle image removal
        document.getElementById('imagePreview').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-btn')) {
                const index = e.target.dataset.index;
                const fileInput = document.getElementById('image');
                const files = Array.from(fileInput.files);

                // Remove the file from the input
                files.splice(index, 1);

                // Create new DataTransfer object and update files
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
                fileInput.files = dataTransfer.files;

                // Trigger change event to update preview
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Handle image selection and preview
        document.getElementById('image').addEventListener('change', function (e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';

            if (!files || files.length === 0) return;

            // Create preview for each file
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'preview-image';
                    previewDiv.dataset.index = index;
                    previewDiv.draggable = true;

                    previewDiv.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button class="remove-btn" data-index="${index}">×</button>
            <button class="move-handle" data-index="${index}">↕</button>
          `;

                    previewContainer.appendChild(previewDiv);
                    setupDragAndDrop(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        });

        // Show delete confirmation modal
        function showModal(productId) {
            // Remove any existing modals first
            const existingModals = document.querySelectorAll('.modal');
            existingModals.forEach(modal => modal.remove());

            deleteIndex = productId;

            // Create a fresh modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'deleteModal';
            modal.innerHTML = `
        <div class="modal-content">
          <p>Are you sure you want to delete this product?</p>
          <div class="modal-buttons">
            <button class="confirm-btn">Yes</button>
            <button class="cancel-btn">No</button>
          </div>
        </div>
      `;

            // Add event listeners to the new buttons
            modal.querySelector('.confirm-btn').addEventListener('click', confirmDelete);
            modal.querySelector('.cancel-btn').addEventListener('click', () => modal.remove());

            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            deleteIndex = -1;
            const modal = document.getElementById('deleteModal');
            if (modal) modal.remove();
        }

        // Confirm delete
        async function confirmDelete() {
            if (deleteIndex !== -1) {
                showLoading();
                try {
                    await deleteProductFromDB(deleteIndex);
                    await renderProducts();

                    // Remove the modal after successful deletion
                    const modal = document.getElementById('deleteModal');
                    if (modal) modal.remove();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Failed to delete product: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
        }

        // Initialize the application
        window.onload = function () {
            if (!checkAuth()) return;

            // Set up activity listeners to reset session timer
            document.addEventListener('mousemove', resetSessionTimer);
            document.addEventListener('keypress', resetSessionTimer);
            document.addEventListener('click', resetSessionTimer);

            // Add logout button
            setupLogoutButton();

            // Initialize the database and render products
            initDB().then(() => {
                renderProducts();
            }).catch(error => {
                console.error('Initialization error:', error);
                alert('Failed to initialize application: ' + error.message);
            });
        };
    </script>
</body>

</html>